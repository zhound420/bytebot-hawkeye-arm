name: bytebot

services:
  bytebot-desktop:
    env_file:
      - .env.defaults
      - .env
    # Build from source with OpenCV 4.8.0
    build:
      context: ..
      dockerfile: packages/bytebotd/Dockerfile
    shm_size: "2g"
    container_name: bytebot-desktop
    restart: unless-stopped
    hostname: computer
    privileged: true
    ports:
      - "9990:9990" # bytebotd service & noVNC
      - "8081:8081" # progress websocket
    environment:
      - DISPLAY=:0
      - BYTEBOT_GRID_OVERLAY=true
      - BYTEBOT_GRID_DEBUG=false
      - BYTEBOT_PROGRESSIVE_ZOOM_USE_AI=true
      - BYTEBOT_UNIVERSAL_TEACHING=${BYTEBOT_UNIVERSAL_TEACHING:-true}
      - BYTEBOT_ADAPTIVE_CALIBRATION=${BYTEBOT_ADAPTIVE_CALIBRATION:-true}
      - BYTEBOT_ZOOM_REFINEMENT=${BYTEBOT_ZOOM_REFINEMENT:-true}
      - BYTEBOT_COORDINATE_METRICS=${BYTEBOT_COORDINATE_METRICS:-true}
      - BYTEBOT_POST_CLICK_CALIBRATION=true
      - BYTEBOT_DRIFT_COMPENSATION=true
      - BYTEBOT_DRIFT_SMOOTHING=0.2
      # Accuracy aids
      - BYTEBOT_PRECLICK_SNAP=true
      - BYTEBOT_SNAP_RADIUS=6
      - BYTEBOT_SNAP_PENALTY=0.25
      - BYTEBOT_CLICK_RETRY_ON_NOCHANGE=true
      - BYTEBOT_CLICK_VERIFY_DELAY=250
      - BYTEBOT_CLICK_VERIFY_RADIUS=12
      - BYTEBOT_CLICK_VERIFY_THRESHOLD=4.0
      - BYTEBOT_CLICK_RETRY_MAX=1
      # OmniParser integration
      - BYTEBOT_CV_USE_OMNIPARSER=${BYTEBOT_CV_USE_OMNIPARSER:-true}
      - OMNIPARSER_URL=${OMNIPARSER_URL:-http://bytebot-omniparser:9989}
      - OMNIPARSER_TIMEOUT=${OMNIPARSER_TIMEOUT:-30000}
    depends_on:
      bytebot-omniparser:
        condition: service_healthy
    networks:
      - bytebot-network
    profiles:
      - linux  # Only start when Linux desktop is selected

  postgres:
    env_file:
      - .env.defaults
      - .env
    image: ${BYTEBOT_POSTGRES_IMAGE:-public.ecr.aws/docker/library/postgres:16-alpine}
    container_name: bytebot-postgres
    restart: unless-stopped
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_USER=postgres
      - POSTGRES_DB=bytebotdb
    networks:
      - bytebot-network
    volumes:
      - postgres_data:/var/lib/postgresql/data

  bytebot-agent:
    env_file:
      - .env.defaults
      - .env
    build:
      context: ..
      dockerfile: packages/bytebot-agent/Dockerfile
    container_name: bytebot-agent
    restart: unless-stopped
    ports:
      - "9991:9991"
    environment:
      - DATABASE_URL=${DATABASE_URL:-postgresql://postgres:postgres@postgres:5432/bytebotdb}
      - BYTEBOT_DESKTOP_BASE_URL=${BYTEBOT_DESKTOP_BASE_URL:-http://bytebot-desktop:9990}
      - BYTEBOT_LLM_PROXY_URL=${BYTEBOT_LLM_PROXY_URL:-http://bytebot-llm-proxy:4000}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - BYTEBOT_ZOOM_REFINEMENT=${BYTEBOT_ZOOM_REFINEMENT:-true}
      - BYTEBOT_GRID_OVERLAY=true
      - BYTEBOT_PROGRESSIVE_ZOOM_USE_AI=true
      # Agent-side verification + screenshot policy
      - BYTEBOT_CLICK_VERIFY=true
      - BYTEBOT_POST_ACTION_SCREENSHOT=true
      - BYTEBOT_INCLUDE_FULL_AFTER_VERIFY=true
      # OmniParser integration
      - BYTEBOT_CV_USE_OMNIPARSER=${BYTEBOT_CV_USE_OMNIPARSER:-true}
      - OMNIPARSER_URL=${OMNIPARSER_URL:-http://bytebot-omniparser:9989}
      - OMNIPARSER_TIMEOUT=${OMNIPARSER_TIMEOUT:-30000}
    depends_on:
      postgres:
        condition: service_started
      bytebot-omniparser:
        condition: service_healthy
    networks:
      - bytebot-network

  bytebot-ui:
    env_file:
      - .env.defaults
      - .env
    build:
      context: ..
      dockerfile: packages/bytebot-ui/Dockerfile
      args:
        - BYTEBOT_AGENT_BASE_URL=${BYTEBOT_AGENT_BASE_URL:-http://bytebot-agent:9991}
        - BYTEBOT_DESKTOP_VNC_URL=${BYTEBOT_DESKTOP_VNC_URL:-http://bytebot-desktop:9990/websockify}
    # Use pre-built image
    image: ghcr.io/bytebot-ai/bytebot-ui:edge
    container_name: bytebot-ui
    restart: unless-stopped
    ports:
      - "9992:9992"
    environment:
      - NODE_ENV=production
      - BYTEBOT_AGENT_BASE_URL=${BYTEBOT_AGENT_BASE_URL:-http://bytebot-agent:9991}
      - BYTEBOT_DESKTOP_VNC_URL=${BYTEBOT_DESKTOP_VNC_URL:-http://bytebot-desktop:9990/websockify}
      - NEXT_PUBLIC_PROGRESS_WS_PORT=${NEXT_PUBLIC_PROGRESS_WS_PORT:-8081}
    depends_on:
      - bytebot-agent
    networks:
      - bytebot-network

  bytebot-omniparser:
    env_file:
      - .env.defaults
      - .env
    build:
      context: ../packages/bytebot-omniparser
      dockerfile: Dockerfile
    container_name: bytebot-omniparser
    restart: unless-stopped
    ports:
      - "9989:9989"
    environment:
      - OMNIPARSER_HOST=0.0.0.0
      - OMNIPARSER_PORT=9989
      # Device auto-detection: 'auto' detects cuda/cpu in container
      # On Apple Silicon: Docker uses CPU (MPS not available in containers)
      # On NVIDIA: Docker uses CUDA if nvidia-docker runtime available
      # Override with: cpu, cuda
      - OMNIPARSER_DEVICE=${OMNIPARSER_DEVICE:-auto}
      - OMNIPARSER_MIN_CONFIDENCE=${OMNIPARSER_MIN_CONFIDENCE:-0.3}
      - OMNIPARSER_MODEL_DTYPE=${OMNIPARSER_MODEL_DTYPE:-float16}
    volumes:
      # Optional: mount weights to persist across rebuilds
      - omniparser_weights:/app/weights
    networks:
      - bytebot-network
    # GPU support configured in docker-compose.override.yml (automatically loaded)
    # Requires: nvidia-container-toolkit installed on host
    # Apple Silicon: MPS not available in Docker, runs on CPU (for GPU use native setup)
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9989/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # OmniBox - Windows 11 Desktop for AI Agents
  # Provides Windows desktop control via Computer Use API
  # Enable/disable via BYTEBOT_ENABLE_OMNIBOX=true/false
  omnibox:
    env_file:
      - .env.defaults
      - .env
    image: dockurr/windows:latest
    container_name: bytebot-omnibox
    privileged: true  # Required for KVM virtualization
    restart: unless-stopped
    ports:
      - "8006:8006"  # Web viewer
      - "3389:3389"  # RDP
      - "5000:5000"  # Computer Use API
      - "5900:5900"  # VNC
    environment:
      # VERSION removed - using custom Tiny11 ISO instead
      - RAM_SIZE=${OMNIBOX_RAM_SIZE:-8G}
      - CPU_CORES=${OMNIBOX_CPU_CORES:-4}
      - DISK_SIZE=${OMNIBOX_DISK_SIZE:-64G}
    devices:
      - /dev/kvm      # KVM virtualization
      - /dev/net/tun  # Network tunneling
    cap_add:
      - NET_ADMIN  # Network administration
    volumes:
      # Cached Tiny11 ISO (symlink to active variant)
      # Download via: ./scripts/download-windows-iso.sh
      - ~/.cache/bytebot/iso/windows.iso:/custom.iso:ro
      # OEM firstboot scripts (runs on first boot via Windows setup)
      - ../packages/omnibox/vm/win11setup/firstboot:/oem
      # Setup scripts (Python server, tools installation)
      - ../packages/omnibox/vm/win11setup/setupscripts:/data
      # Persistent VM storage
      - omnibox_data:/storage
    networks:
      - bytebot-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/probe"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 300s  # Windows setup takes 20-90 minutes on first boot
    profiles:
      - omnibox  # Only start when explicitly requested

  # OmniBox Adapter - Windows Desktop Control Service
  # Provides bytebotd-compatible API for OmniBox/Windows
  omnibox-adapter:
    env_file:
      - .env.defaults
      - .env
    build:
      context: ..
      dockerfile: packages/omnibox-adapter/Dockerfile
    container_name: bytebot-omnibox-adapter
    restart: unless-stopped
    ports:
      - "5001:5001"
    environment:
      - NODE_ENV=production
      - PORT=5001
      - OMNIBOX_URL=http://omnibox:5000
      - OMNIBOX_TIMEOUT=${OMNIBOX_TIMEOUT:-30000}
      - OMNIPARSER_URL=${OMNIPARSER_URL:-http://bytebot-omniparser:9989}
      - OMNIPARSER_TIMEOUT=${OMNIPARSER_TIMEOUT:-30000}
      - BYTEBOT_CV_USE_OMNIPARSER=${BYTEBOT_CV_USE_OMNIPARSER:-true}
    depends_on:
      omnibox:
        condition: service_healthy
      bytebot-omniparser:
        condition: service_healthy
    networks:
      - bytebot-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5001/computer-use"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    profiles:
      - omnibox  # Only start when explicitly requested

networks:
  bytebot-network:
    driver: bridge

volumes:
  postgres_data:
  omniparser_weights:
  omnibox_data:
